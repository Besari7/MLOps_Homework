# GitHub Actions CI/CD Pipeline for High Cardinality Prediction Service
# Pipeline Stages: Build -> Unit Test -> Lint -> Package -> Smoke Test

name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Stage 1: Build - Install dependencies
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify installation
        run: |
          python -c "import flask; print(f'Flask version: {flask.__version__}')"
          python -c "import pytest; print(f'Pytest version: {pytest.__version__}')"
          python -c "import mmh3; print('mmh3 installed successfully')"

  # Stage 2: Unit Test - Fast, isolated tests
  unit-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Unit Tests
        run: |
          cd tests
          python -m pytest test_feature_engineering.py -v --tb=short
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  # Stage 3: Integration Test - Component tests
  integration-test:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Integration Tests
        run: |
          cd tests
          python -m pytest test_integration.py -v --tb=short
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  # Stage 4: Lint - Code quality check
  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run Flake8 Linting
        run: |
          echo "Running flake8 on src/ directory..."
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          echo "Running flake8 with extended checks..."
          flake8 src/ --count --max-complexity=10 --max-line-length=120 --statistics

  # Stage 5: Package - Build Docker image
  package:
    runs-on: ubuntu-latest
    needs: [unit-test, integration-test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: prediction-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Verify Docker image
        run: |
          docker images prediction-service:${{ github.sha }}
          echo "Docker image built successfully!"

      - name: Save Docker image
        run: |
          docker save prediction-service:${{ github.sha }} > prediction-service.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: prediction-service.tar
          retention-days: 1

  # Stage 6: Smoke Test - Deployment verification
  smoke-test:
    runs-on: ubuntu-latest
    needs: package
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: |
          docker load < prediction-service.tar

      - name: Start container
        run: |
          docker run -d --name prediction-service -p 5000:5000 prediction-service:${{ github.sha }}
          echo "Container started, waiting for service to be ready..."

      - name: Set up Python for smoke test
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Run Smoke Test
        run: |
          python tests/smoke_test.py --url http://localhost:5000

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Container Logs ==="
          docker logs prediction-service

      - name: Stop container
        if: always()
        run: |
          docker stop prediction-service || true
          docker rm prediction-service || true
